# IBM FHIR Server - fhir-persistence-schema

Builds and manages the multi-tenant FHIR R4 RDBMS schema (DB2). Includes Derby support for use in unit-tests.


# Run Configurations

## Drop tables from FHIR_ADMIN and FHIRDATA

```
--prop-file fhir.properties
--schema-name FHIRDATA
--drop-schema
--drop-admin
--confirm-drop
```

## Creates New Schema

```
--prop-file fhir.properties
--schema-name FHIRDATA
--create-schemas
```

## Deploy New Schema

```
--prop-file fhir.properties
--schema-name FHIRDATA
--update-schema
```

## Add a new tenant (e.g. TNT1)

Don't forget to copy the tenant-key secret generated by --allocate-tenant. This key must be added to the datasource configuration to authorize the FHIR server to access this tenant.

```
--prop-file fhir.properties
--schema-name FHIRDATA
--allocate-tenant TNT1
```


## Grant privileges to data access user

```
--prop-file fhir.properties
--schema-name FHIRDATA
--grant-to FHIRSERVER
```

## Configure tenant-key (example)

Edit `wlp/usr/servers/fhir-server/config/TNT1/fhir-server-config.json` and add the tenant-key captured from the add-tenant step above:

```
               "default": {
                    "tenantKey": "<the-base64-tenant-key>",
                    "type": "db2",
                    "connectionProperties": {
                        "serverName": "<db2-host-name>",
                        "portNumber": 50001,
                        "databaseName": "BLUDB",
                        "apiKey": "<your-db2-api-key>",
                        "securityMechanism": 15,
                        "pluginName": "IBMIAMauth",
                        "currentSchema": "FHIRDATA",
                        "driverType": 4,
                        "sslConnection": true,
                        "sslTrustStoreLocation": "resources/security/dbTruststore.jks",
                        "sslTrustStorePassword": "<your-ssl-truststore-password>"
                    }

```

## Test a tenant

```
--prop-file fhir-apikey.properties
--schema-name FHIRDATA
--test-tenant TNT1
--tenant-key "<the-base64-tenant-key>"
```

## Update the data (not admin) procedures only

```
--prop-file config/fhir.properties
--schema-name FHIRDATA
--update-proc
```

FHIRÂ® is the registered trademark of HL7 and is used with the permission of HL7.
